<?php

namespace {{pascalcase namespace}}\Plugin;

use Illuminate\Support\Collection;
use Psr\Container\ContainerInterface;
use {{pascalcase namespace}}\Asset\Contract\AssetInterface;
use {{pascalcase namespace}}\Block\Contract\BlockInterface;
use {{pascalcase namespace}}\Block\Contract\BlockRepositoryInterface;
use {{pascalcase namespace}}\Asset\Contract\ManifestInterface;

/**
 * Register {{lowercase (dashcase namespace)}}/{{lowercase (dashcase name)}} block assets
 *
 * @see Enqueueing Editor Assets <https://git.io/JvPHy>
 * @see Dependency Extraction Webpack Plugin <https://git.io/Jv1ll>
 */
class Registration
{
    /** @var ContainerInterface */
    public $bud;

    /** @var Collection */
    public $collection;

    /** @var BlockRepositoryInterface */
    public $blocks;

    /** @var ManifestInterface */
    public $manifest;

    /**
      * Class constructor.
      *
      * @param ContainerInterface       $bud
      * @param Collection               $collection
      * @param BlockRepositoryInterface $blocks
      * @param ManifestInterface        $manifest
      */
    public function __construct(
        ContainerInterface $bud,
        Collection $collection,
        BlockRepositoryInterface $blocks,
        ManifestInterface $manifest
    ) {
        $this->bud = $bud;
        $this->collection = $collection;
        $this->blocks = $blocks;
        $this->manifest = $manifest;
    }

    /**
      * Class invocation.
      *
      * @throws \WP_Error
      * @return void
      */
    public function __invoke(): void
    {
        $this->load();
        $this->register();
    }

    /**
      * Load blocks and assets.
      *
      * @return void
      */
    private function load(): void
    {
        $this->globPluginBlocks()->each(function ($name) {
            $block = $this->bud->make(BlockInterface::class);

            $block->setName($name);

            $block->setAssets($this->manifest->getAssets($block));

            $this->blocks->add($block);
        });
    }

    /**
      * Register blocks and their assets.
      *
      * @return void
      */
    private function register(): void
    {
        $this->blocks->all()->each(function (BlockInterface $block) {
            $block->getAssets()->each(function (AssetInterface $asset) {
                $asset->register();
            });
        })->each(function (BlockInterface $block) {
            $block->register();
        });
    }

    /**
     * Glob Plugin blocks.
     */
     private function globPluginBlocks()
     {
         return $this->collection::make(
            glob($this->bud->get('path.plugin.src.blocks') . '/*', GLOB_ONLYDIR)
        )
        ->map(function ($path) {
            return str_replace($this->bud->get('path.plugin.src.blocks') . '/', '', $path);
        });
     }
}
