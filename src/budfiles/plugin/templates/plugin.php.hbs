<?php
/**
 * Plugin Name:  {{name}}
 * Plugin URI:   {{lowercase website}}
 * Description:  {{description}}
 * Author:       {{titleize author}} <{{lowercase email}}>
 * License:      MIT
 * Text Domain:  {{lowercase (dashcase namespace)}}
 */

namespace {{pascalcase namespace}}\\{{pascalcase name}};

/**
 * Register {{lowercase (dashcase namespace)}}/{{lowercase (dashcase name)}} block assets
 *
 * @see Enqueueing Editor Assets <https://git.io/JvPHy>
 * @see Dependency Extraction Webpack Plugin <https://git.io/Jv1ll>
 */
add_action('init', function () {
  (new class {
    /**
     * Namespace
     *
     * @var string
     */
    public $namespace = '{{lowercase (dashcase namespace)}}';

    /**
     * Plugin directory.
     *
     * @var string
     */
    public $dir;

    /**
     * Class constructor.
     */
    public function __construct()
    {
      $this->dir = dirname(__FILE__);
      $this->assetManifest = $this->getAssetManifest();
    }

    /**
     * Class invocation.
     *
     * @throws \WP_Error
     * @return void
     */
    public function __invoke(): void
    {
        foreach ($this->getAssetsOfType('blocks') as $block) {
            $name = ltrim(basename($block), '/');
            $this->registerBlockScripts($name);
            $this->registerBlockStyles($name);
            $this->registerBlockType($name);
        }

        foreach ($this->getAssetsOfType('extensions') as $extension) {
            $name = ltrim(basename($extension), '/');
            $this->registerExtension($name);
        }
    }

    /**
     * Glob assets from src directory
     *
     * @param  string
     * @return array
     */
    protected function getAssetsOfType(string $type): array
    {
        return glob("{$this->dir}/src/{$type}/*", GLOB_ONLYDIR);
    }

    /**
     * Register block scripts.
     *
     * @param  string
     * @return void
     */
    protected function registerBlockScripts(string $block): void
    {
        foreach (['editor', 'public'] as $context) {
            wp_register_script(
                "{$this->namespace}/{$block}/{$context}/js",
                $this->assetManifest["blocks/{$block}/{$context}.js"],
                ...$this->getDependencyManifest($block, $context)
            );
        }
    }

    /**
     * Register block styles.
     *
     * @param  string
     * @return void
     */
    protected function registerBlockStyles(string $block): void
    {
        foreach (['editor', 'public'] as $context) {
            wp_register_style(
                "{$this->namespace}/{$block}/{$context}/css",
                $this->assetManifest["blocks/{$block}/styles/{$context}.css"],
                [],
                null
            );
        }
    }

    /**
     * Get webpack dependency manifest.
     *
     * @return array
     */
    protected function getAssetManifest(): array
    {
        if (!realpath($manifestFile = "{$this->dir}/dist/manifest.json")) {
            new \WP_Error(
                __('asset_manifest_not_found', '{{lowercase (dashcase namespace)}}'),
                __('There was an issue with the acme-project plugin', '{{lowercase (dashcase namespace)}}'),
                __('Asset manifest not found. Please run the plugin build scripts.', '{{lowercase (dashcase namespace)}}')
            );
        }

        $manifest = file_get_contents($manifestFile);
        return json_decode($manifest, true);
    }

    /**
     * Get webpack dependency manifest.
     *
     * @return array
     */
    protected function getDependencyManifest($block, $script): array
    {
        if (!realpath("{$this->dir}/dist/blocks/{$block}/{$script}.asset.json")) {
            new \WP_Error(
                __('dependency_manifest_not_found', '{{lowercase (dashcase namespace)}}'),
                __('There was an issue with the acme-project plugin', '{{lowercase (dashcase namespace)}}'),
                __('Asset manifest not found. Please run the plugin build scripts.', '{{lowercase (dashcase namespace)}}')
            );
        }

        $manifest = file_get_contents($manifestFile);
        return array_values(json_decode($manifest, true));
    }

    /**
     * Register block assets.
     *
     * @param  string
     * @return void
     */
    protected function registerBlockType(string $block): void
    {
        register_block_type("{$this->namespace}/{$block}", [
            'editor_script' => "{$this->namespace}/{$block}/editor/js",
            'editor_style' => "{$this->namespace}/{$block}/editor/css",
            'script' => "{$this->namespace}/{$block}/public/js",
            'style' => "{$this->namespace}/{$block}/public/css",
        ]);
    }

    /**
     * Register extension scripts.
     *
     * @param  string
     * @return void
     */
    protected function registerExtension($extension): void
    {
        wp_register_script(
            "{$this->namespace}/{$extension}/js",
            "{$this->getHost()}/{$extension}.js",
            ...$this->getDependencyManifest($extension, 'scripts')
        );

        add_action('enqueue_block_editor_assets', function () use ($extension) {
            wp_enqueue_script("{$this->namespace}/{$extension}/js");
        });
    }
  })();
});
